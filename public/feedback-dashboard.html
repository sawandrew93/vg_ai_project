<!DOCTYPE html>
<html>
<head>
    <title>Customer Feedback Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .header { background: #007bff; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; margin-top: 0.5rem; }
        .filters { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-weight: 500; color: #333; }
        .filter-group select, .filter-group input { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .feedback-table { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .rating { display: flex; gap: 2px; }
        .star { color: #ffc107; }
        .star.empty { color: #ddd; }
        .interaction-type { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .interaction-type.ai_only { background: #e3f2fd; color: #1976d2; }
        .interaction-type.human_agent { background: #e8f5e8; color: #2e7d32; }
        .intent-tag { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; background: #f0f0f0; color: #333; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .no-data { text-align: center; padding: 2rem; color: #666; }
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .page-btn { padding: 0.5rem 0.75rem; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .feedback-text { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
        .feedback-text:hover { white-space: normal; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Customer Feedback Dashboard</h1>
        <div>
            <button onclick="window.location.href='/intents'" class="btn">üéØ Intents</button>
            <button onclick="window.location.href='/knowledge-base'" class="btn">üß† Knowledge Base</button>
            <button onclick="window.location.href='/agent'" class="btn">üè† Agent Dashboard</button>
            <button onclick="logout()" class="btn">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalFeedback">-</div>
                <div class="stat-label">Total Feedback</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgRating">-</div>
                <div class="stat-label">Average Rating</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="aiOnlyCount">-</div>
                <div class="stat-label">AI Only</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="humanAgentCount">-</div>
                <div class="stat-label">Human Agent</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Interaction Type</label>
                <select id="interactionFilter">
                    <option value="">All</option>
                    <option value="ai_only">AI Only</option>
                    <option value="human_agent">Human Agent</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Rating</label>
                <select id="ratingFilter">
                    <option value="">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="3">3 Stars</option>
                    <option value="2">2 Stars</option>
                    <option value="1">1 Star</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="applyFilters()" class="btn">Apply Filters</button>
            </div>
        </div>

        <div class="feedback-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Rating</th>
                        <th>Type</th>
                        <th>Agent</th>
                        <th>Feedback</th>
                        <th>Session</th>
                    </tr>
                </thead>
                <tbody id="feedbackTableBody">
                    <tr><td colspan="7" class="loading">Loading feedback...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 20;

        async function loadFeedback(page = 1) {
            try {
                const token = localStorage.getItem('agentToken');
                if (!token) {
                    window.location.href = '/agent';
                    return;
                }

                const params = new URLSearchParams({
                    limit: pageSize,
                    offset: (page - 1) * pageSize
                });

                // Add filters
                const interactionFilter = document.getElementById('interactionFilter').value;
                const ratingFilter = document.getElementById('ratingFilter').value;
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;

                if (interactionFilter) params.append('interaction_type', interactionFilter);
                if (ratingFilter) params.append('rating', ratingFilter);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);

                const response = await fetch(`/api/feedback?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load feedback');

                const data = await response.json();
                displayFeedback(data);
                updateStats(data);
                currentPage = page;
            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackTableBody').innerHTML = 
                    '<tr><td colspan="7" class="no-data">Error loading feedback</td></tr>';
            }
        }

        function displayFeedback(feedback) {
            const tbody = document.getElementById('feedbackTableBody');
            
            if (feedback.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No feedback found</td></tr>';
                return;
            }

            tbody.innerHTML = feedback.map(item => `
                <tr>
                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                    <td>
                        <div>${item.customer_name || 'Anonymous'}</div>
                        <div style="font-size: 0.8em; color: #666;">${item.customer_email || ''}</div>
                    </td>
                    <td>
                        <div class="rating">
                            ${Array.from({length: 5}, (_, i) => 
                                `<span class="star ${i < item.rating ? '' : 'empty'}">‚òÖ</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td>
                        <span class="interaction-type ${item.interaction_type}">
                            ${item.interaction_type === 'ai_only' ? 'AI Only' : 'Human Agent'}
                        </span>
                    </td>
                    <td>${item.agent_name || (item.interaction_type === 'ai_only' ? 'AI Assistant' : '-')}</td>
                    <td>
                        <div class="feedback-text" title="${item.feedback_text || ''}">
                            ${item.feedback_text || 'No feedback text'}
                        </div>
                    </td>
                    <td style="font-family: monospace; font-size: 0.8em;">${item.session_id.substring(0, 12)}...</td>
                </tr>
            `).join('');
        }

        function updateStats(feedback) {
            const total = feedback.length;
            const avgRating = total > 0 ? (feedback.reduce((sum, item) => sum + item.rating, 0) / total).toFixed(1) : 0;
            const aiOnly = feedback.filter(item => item.interaction_type === 'ai_only').length;
            const humanAgent = feedback.filter(item => item.interaction_type === 'human_agent').length;

            document.getElementById('totalFeedback').textContent = total;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('aiOnlyCount').textContent = aiOnly;
            document.getElementById('humanAgentCount').textContent = humanAgent;
        }

        function applyFilters() {
            loadFeedback(1);
        }

        function logout() {
            localStorage.removeItem('agentToken');
            window.location.href = '/agent';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFeedback();
        });
    </script>
    <script src="agent-notifications.js"></script>
</body>
</html>